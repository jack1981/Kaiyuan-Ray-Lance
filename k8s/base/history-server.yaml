apiVersion: apps/v1
kind: Deployment
metadata:
  name: spark-history-server
  namespace: kaiyuan-spark
  labels:
    app: spark-history-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: spark-history-server
  template:
    metadata:
      labels:
        app: spark-history-server
    spec:
      serviceAccountName: spark
      containers:
        - name: spark-history-server
          image: kaiyuan-spark-app:latest
          imagePullPolicy: IfNotPresent
          command: ["bash", "-lc"]
          args:
            - |
              set -euo pipefail
              : "${MINIO_ENDPOINT:=http://minio.kaiyuan-spark.svc.cluster.local:9000}"
              : "${MINIO_ACCESS_KEY:=minio}"
              : "${MINIO_SECRET_KEY:=minio123}"
              : "${MINIO_BUCKET:=kaiyuan-spark}"
              : "${SPARK_HISTORY_LOG_DIR:=s3a://${MINIO_BUCKET}/spark-events}"

              export SPARK_HISTORY_OPTS="-Dspark.history.fs.logDirectory=${SPARK_HISTORY_LOG_DIR} -Dspark.history.fs.update.interval=10s -Dspark.history.ui.port=18080 -Dspark.history.retainedApplications=200 -Dspark.history.fs.cleaner.enabled=true -Dspark.history.fs.cleaner.interval=1d -Dspark.history.fs.cleaner.maxAge=7d -Dspark.hadoop.fs.s3a.impl=org.apache.hadoop.fs.s3a.S3AFileSystem -Dspark.hadoop.fs.s3a.endpoint=${MINIO_ENDPOINT} -Dspark.hadoop.fs.s3a.path.style.access=true -Dspark.hadoop.fs.s3a.connection.ssl.enabled=false -Dspark.hadoop.fs.s3a.access.key=${MINIO_ACCESS_KEY} -Dspark.hadoop.fs.s3a.secret.key=${MINIO_SECRET_KEY} -Dspark.hadoop.fs.s3a.aws.credentials.provider=org.apache.hadoop.fs.s3a.SimpleAWSCredentialsProvider"
              exec /opt/spark/bin/spark-class org.apache.spark.deploy.history.HistoryServer
          env:
            - name: MINIO_ENDPOINT
              value: http://minio.kaiyuan-spark.svc.cluster.local:9000
            - name: MINIO_BUCKET
              value: kaiyuan-spark
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: MINIO_ROOT_USER
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: MINIO_ROOT_PASSWORD
          ports:
            - name: web-ui
              containerPort: 18080
          readinessProbe:
            httpGet:
              path: /
              port: web-ui
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /
              port: web-ui
            initialDelaySeconds: 30
            periodSeconds: 20
---
apiVersion: v1
kind: Service
metadata:
  name: spark-history-server
  namespace: kaiyuan-spark
  labels:
    app: spark-history-server
spec:
  selector:
    app: spark-history-server
  ports:
    - name: web-ui
      port: 18080
      targetPort: web-ui
